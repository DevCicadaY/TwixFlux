import os  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
import subprocess  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–º–∞–Ω–¥
from src.utils.logger import logger  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤

def kill_process_on_port(port):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ—Ä—Ç.
    
    :param port: –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∏—â—É—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ—Ä—Ç
        logger.info(f"üîç –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É {port}...")  # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—á–∞–ª–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—Ç—É
        result = subprocess.run(
            ['lsof', '-t', '-i', f':{port}'],  # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É lsof –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã–π –ø–æ—Ä—Ç
            stdout=subprocess.PIPE, stderr=subprocess.PIPE  # –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥ –∏ –æ—à–∏–±–∫–∏ –∫–æ–º–∞–Ω–¥—ã
        )
        
        # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ lsof –Ω–∞—à–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å—ã
        if result.stdout:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–≤–æ–¥ –∏–∑ –∫–æ–º–∞–Ω–¥—ã (—Ç–æ –µ—Å—Ç—å, –ø—Ä–æ—Ü–µ—Å—Å—ã –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã)
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ PID (–ø—Ä–æ—Ü–µ—Å—Å ID)
            pids = result.stdout.decode('utf-8').splitlines()  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã–≤–æ–¥ –≤ —Å—Ç—Ä–æ–∫–∏ –∏ —Ä–∞–∑–¥–µ–ª—è–µ–º –ø–æ —Å—Ç—Ä–æ–∫–∞–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ PID
            
            for pid in pids:  # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ PID
                # –ó–∞–≤–µ—Ä—à–∞–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º PID
                kill_result = subprocess.run(['kill', '-9', pid], stdout=subprocess.PIPE, stderr=subprocess.PIPE)  # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã kill
                if kill_result.returncode == 0:  # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ kill –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
                    logger.info(f"üõë –ü—Ä–æ—Ü–µ—Å—Å —Å PID {pid} –±—ã–ª –∑–∞–≤–µ—Ä—à—ë–Ω –Ω–∞ –ø–æ—Ä—Ç—É {port}.")  # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
                else:  # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ kill –≤–µ—Ä–Ω—É–ª–∞ –æ—à–∏–±–∫—É
                    logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å PID {pid} –Ω–∞ –ø–æ—Ä—Ç—É {port}.")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
        else:  # –ï—Å–ª–∏ lsof –Ω–µ –Ω–∞—à–µ–ª –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É
            logger.info(f"‚úÖ –ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –ø–æ—Ä—Ç {port}.")  # –õ–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ –Ω–∞ –ø–æ—Ä—Ç—É –Ω–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    except Exception as e:  # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã: {e}")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É

if __name__ == "__main__":  # –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
    # –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 8000
    logger.info("‚öôÔ∏è –ó–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 8000...")  # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 8000
    kill_process_on_port(8000)  # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 8000