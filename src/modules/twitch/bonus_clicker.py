import datetime  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º
import time  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º (–∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –ø–∞—É–∑—ã)
import threading  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å—é (–ø–æ—Ç–æ–∫–∏)
from selenium.webdriver.common.by import By  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –º–µ—Ç–æ–¥–∞ –ø–æ–∏—Å–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
from selenium.webdriver.support.ui import WebDriverWait  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
from selenium.webdriver.support import expected_conditions as EC  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –¥–ª—è —É—Å–ª–æ–≤–∏–π –æ–∂–∏–¥–∞–Ω–∏—è
from src.utils.logger import logger  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤

def get_bonus(driver, timeout_minutes=10, sleep_time=30):  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ —Å –∫–Ω–æ–ø–∫–∏
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ —Å –∫–Ω–æ–ø–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
    
    :param driver: –≠–∫–∑–µ–º–ø–ª—è—Ä Selenium WebDriver.
    :param timeout_minutes: –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10).
    :param sleep_time: –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30).
    """
    bonus_button_xpath = "//button[contains(@aria-label, '–ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å')]"  # XPath –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
    end_time = datetime.datetime.now() + datetime.timedelta(minutes=timeout_minutes)  # –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

    logger.info(f"üîÑ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞. –¢–∞–π–º–∞—É—Ç: {timeout_minutes} –º–∏–Ω—É—Ç, –∑–∞–¥–µ—Ä–∂–∫–∞: {sleep_time} —Å–µ–∫—É–Ω–¥.")  # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤
    
    def bonus_thread():  # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        try:
            while datetime.datetime.now() < end_time:  # –í—ã–ø–æ–ª–Ω—è–µ–º —Ü–∏–∫–ª –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ç–∞–π–º–∞—É—Ç–∞
                # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –±—Ä–∞—É–∑–µ—Ä
                try:
                    driver.title  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)
                except Exception as e:
                    logger.error(f"üö® –ë—Ä–∞—É–∑–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –±—ã–ª –∑–∞–∫—Ä—ã—Ç: {e}")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                    break  # –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

                try:
                    bonus_button = WebDriverWait(driver, 10).until(  # –û–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π
                        EC.element_to_be_clickable((By.XPATH, bonus_button_xpath))  # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ –∫–Ω–æ–ø–∫–µ
                    )
                    bonus_button.click()  # –ù–∞–∂–∏–º–∞–µ–º –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
                    logger.info("‚úÖ –ë–æ–Ω—É—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω.")  # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞
                except Exception as e:
                    logger.debug(f"üîç –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞: {e}")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞
                
                # –õ–æ–≥–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –ø–∞—É–∑–æ–π
                logger.info(f"üïí –û–∂–∏–¥–∞–Ω–∏–µ {sleep_time} —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.")  # –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–µ—Ä–∂–∫–µ
                time.sleep(sleep_time)  # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π

            logger.info("‚è≥ –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É.")  # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É
        except Exception as e:  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
            logger.error(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–æ–Ω—É—Å–æ–≤: {e}")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É

    # –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    bonus_thread_instance = threading.Thread(target=bonus_thread)  # –°–æ–∑–¥–∞—ë–º –ø–æ—Ç–æ–∫ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
    bonus_thread_instance.start()  # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
    
    logger.info("üåÄ –ó–∞–¥–∞—á–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞ –∑–∞–ø—É—â–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.")  # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ –≤ –ø–æ—Ç–æ–∫–µ
    
    def stop_bonus_thread():  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
        """
        –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞.
        """
        bonus_thread_instance.join(timeout=1)  # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞ —Å —Ç–∞–π–º-–∞—É—Ç–æ–º
        if bonus_thread_instance.is_alive():  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∂–∏–≤ –ª–∏ –ø–æ—Ç–æ–∫
            logger.info("‚ö†Ô∏è –ó–∞–¥–∞—á–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")  # –õ–æ–≥–∏—Ä—É–µ–º, –µ—Å–ª–∏ –ø–æ—Ç–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        else:
            logger.info("‚úÖ –ó–∞–¥–∞—á–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")  # –õ–æ–≥–∏—Ä—É–µ–º, –µ—Å–ª–∏ –ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω
    
    return stop_bonus_thread  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞