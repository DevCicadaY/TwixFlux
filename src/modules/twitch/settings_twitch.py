from src.utils.logger import logger  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π
from settings.settings import get_settings_path, load_settings_by_category, TWITCH  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
import json  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON –¥–∞–Ω–Ω—ã–º–∏

def get_stream_url():
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç URL-–∞–¥—Ä–µ—Å Twitch —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ TWITCH.
    """
    try:
        logger.info(f"üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ '{TWITCH}'...")  # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
        twitch_settings = load_settings_by_category(TWITCH)  # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TWITCH

        # –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º üìù
        STREAM_URL = twitch_settings.get("stream_url")  # –ü–æ–ª—É—á–∞–µ–º URL Twitch —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ URL
        if not STREAM_URL:
            error_message = "–ü–∞—Ä–∞–º–µ—Ç—Ä 'stream_url' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö TWITCH."
            logger.error(f"‚ùå {error_message}")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            raise ValueError(error_message)

        # –í—ã–≤–æ–¥–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ª–æ–≥–∏ üîç
        logger.info(f"üé• STREAM_URL: {STREAM_URL}")  # –õ–æ–≥–∏—Ä—É–µ–º URL Twitch —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏

        return STREAM_URL  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º URL
    except Exception as e:  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å
        logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ '{TWITCH}': {e}", exc_info=True)  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º
        raise  # –ü–æ–≤—Ç–æ—Ä–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

def update_stream_url(new_url):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç URL-–∞–¥—Ä–µ—Å Twitch —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö TWITCH.
    """
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        logger.info(f"üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ '{TWITCH}'...")  # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

        # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞
        settings_path = get_settings_path()  # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
        with open(settings_path, 'r') as file:
            twitch_settings = json.load(file)  # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä 'stream_url'
        if not new_url:
            error_message = "–ù–æ–≤—ã–π URL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
            logger.error(f"‚ùå {error_message}")  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            raise ValueError(error_message)  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–æ–≤—ã–π URL –ø—É—Å—Ç–æ–π

        # –û–±–Ω–æ–≤–ª—è–µ–º URL —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –≤ –Ω—É–∂–Ω–æ–π —Å–µ–∫—Ü–∏–∏
        twitch_settings["TWITCH"]["stream_url"] = new_url

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ settings.json
        with open(settings_path, 'w') as file:
            json.dump(twitch_settings, file, indent=4)  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ JSON

        logger.info(f"‚úÖ URL –æ–±–Ω–æ–≤–ª–µ–Ω: {new_url}")  # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

    except Exception as e:
        logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: {e}", exc_info=True)  # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º
        raise  # –ü–æ–≤—Ç–æ—Ä–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ